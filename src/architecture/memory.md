Added Pyro pipeline/model modules based on `src/architecture/pyro_pipeline_skeleton.md`, `src/architecture/pyro_context.md`, and `src/architecture/pyro_model.md`.
Implemented observed-data preprocessing (step 1) in `scripts/pyro_io.py`, including guide mapping, raw-k filtering (drop cells with k > Kmax), guide-map mismatch warnings, and padded guide inputs with NTCs mapped to guide_id=0 (mask=1) and padding mask=0.
Implemented guide-level decomposition (step 3) and linear predictor (step 4) helpers in `src/models/pyro_model.py` via `build_guide_effects` and `compute_linear_predictor`.
Implemented steps 5–7 in `src/models/pyro_model.py` inside `fate_model`: priors, random-walk gene effects, guide deviations, softmax mapping, and soft-label likelihood with a config-driven fate order and reference fate.
Implemented steps 8–10 in `src/models/pyro_model.py`: minibatched SVI via `fit_svi` (uses `pyro.plate` subsampling) with correct N/B scaling.
Implemented step 11 in `src/models/pyro_model.py`: `reconstruct_theta_samples` draws posterior theta samples and `export_gene_summary_for_ash` computes weighted summaries for a configurable contrast fate; day-weight columns (`w0..w{D-1}`) are added for traceability. Optional stratified bootstrap SE can be enabled in `scripts/fit_pyro_export.py` via `config.yaml`.
Implemented step 12 in pipeline form: added `scripts/fit_pyro_export.py`, `scripts/run_ash.R`, and `scripts/rank_hits.py`, plus `config.yaml` (now includes ref_fate/contrast_fate), `Snakefile`, and conda env specs in `envs/`.
Implemented step 13 diagnostics in `scripts/run_diagnostics.py` (holdout cross-entropy for full vs nuisance-only model; optional guide permutation with a Python-only p-value/BH qvalue hit-rate proxy; optional sanity checks for expected gene-direction effects).
Updated `config.yaml` to include prior scale knobs (`s_time`, `s_guide`) and set them to 0.3 and 0.5 for noisier recovery.
Exposed `s_tau` as a configurable prior scale (passed through `fit_svi` and scripts) and added `scripts/simulate_tau_sweep.py` plus a `sim_tau_sweep` Snakefile target for recovery experiments.
Added fixed per-interval time scaling (`time_scale`) for the random-walk increments in `src/models/pyro_model.py`, validated in `scripts/pyro_io.py`, threaded through fit/export/diagnostics, and documented in `src/architecture/pyro_model.md`.
Removed unused pipeline stubs from `src/models/pyro_pipeline.py`; only shared helpers (`make_k_centered`, `to_torch`) remain.
Remaining manual/optional items from `src/architecture/pyro_model.md`: manual review of sanity-check outputs (if enabled).
Updated the core Pyro model in `src/models/pyro_model.py` to use fixed-scale priors for alpha/rep/gamma (no hyper-SDs), switched to per-interval `sigma_time` with learned increments (removed `time_scale` scaling), and added a `likelihood_weight` multiplier on the soft-label log-likelihood; updated `fit_svi` and reconstruction utilities to match the new `sigma_time` shape.
Updated exporters and utilities to match the new time-innovation parameterization: added `export_gene_summary_for_mash` (daywise betahat/se), switched `scripts/fit_pyro_export.py` to mashr export, updated diagnostics/loglik reconstruction to the new `sigma_time` shape and likelihood weight, refreshed simulation code/tests to match per-interval `sigma_time`, and removed `time_scale` usage from fitting/export paths.
Added mashr discovery integration: new `envs/mash.yaml` and `scripts/run_mashr.R`, updated `Snakefile` to output `gene_summary_for_mash.csv` then run mashr before `rank_hits`, updated simulation workflow to run mashr, and revised `scripts/rank_hits.py` for mash outputs; `config.yaml` now includes s_alpha/s_rep/s_gamma/s_tau/s_time/s_guide defaults, `likelihood_weight`, and `mash_lfsr_thresh`, with `scripts/pyro_io.py` coercing the new float keys.
Fixed `scripts/run_mashr.R` to compare day indices without name attributes so betahat/se day columns align correctly.
Ran `sim_all` with `sim_cells=500`, `sim_genes=60`, `sim_concentration=200` (no hyperparameter changes); mashr produced 1 hit (Gene57, best_day=3) with `lfsr_min=1e-05` and updated sim outputs in `out_fate_pipeline_sim/`.
Computed daywise ground-truth counts for the same sim settings (seed 0, N=500, L=60, G=90, Kmax=4, concentration=200): day0=29, day1=32, day2=33, day3=37, any-day=47 genes with |beta|>0.2.
Updated `scripts/run_mashr.R` to fall back to identity covariance when `estimate_null_correlation_simple` fails (e.g., insufficient null data), avoiding mashr crashes on small panels.
Ran the real-data pipeline on simulated inputs via Snakemake (fit→mashr→rank with allowed rules). Mashr used identity covariance fallback due to insufficient null data; `out_fate_pipeline_sim/hits_ranked.csv` produced multiple hits (top hits printed in console).
