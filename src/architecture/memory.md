Added Pyro pipeline/model modules based on `src/architecture/pyro_pipeline_skeleton.md`, `src/architecture/pyro_context.md`, and `src/architecture/pyro_model.md`.
Implemented observed-data preprocessing (step 1) in `scripts/pyro_io.py`, including guide mapping, raw-k filtering (drop cells with k > Kmax), guide-map mismatch warnings, and padded guide inputs with NTCs mapped to guide_id=0 (mask=1) and padding mask=0.
Implemented guide-level decomposition (step 3) and linear predictor (step 4) helpers in `src/models/pyro_model.py` via `build_guide_effects` and `compute_linear_predictor`.
Implemented steps 5–7 in `src/models/pyro_model.py` inside `fate_model`: priors, random-walk gene effects, guide deviations, softmax mapping, and soft-label likelihood with a config-driven fate order and reference fate.
Implemented steps 8–10 in `src/models/pyro_model.py`: minibatched SVI via `fit_svi` (uses `pyro.plate` subsampling) with correct N/B scaling.
Implemented step 11 in `src/models/pyro_model.py`: `reconstruct_theta_samples` draws posterior theta samples and `export_gene_summary_for_ash` computes weighted summaries for a configurable contrast fate; day-weight columns (`w0..w{D-1}`) are added for traceability. Optional stratified bootstrap SE can be enabled in `scripts/fit_pyro_export.py` via `config.yaml`.
Implemented step 12 in pipeline form: added `scripts/fit_pyro_export.py`, `scripts/run_ash.R`, and `scripts/rank_hits.py`, plus `config.yaml` (now includes ref_fate/contrast_fate), `Snakefile`, and conda env specs in `envs/`.
Implemented step 13 diagnostics in `scripts/run_diagnostics.py` (holdout cross-entropy for full vs nuisance-only model; optional guide permutation with a Python-only p-value/BH qvalue hit-rate proxy; optional sanity checks for expected gene-direction effects).
Updated `config.yaml` to include prior scale knobs (`s_time`, `s_guide`) and set them to 0.3 and 0.5 for noisier recovery.
Exposed `s_tau` as a configurable prior scale (passed through `fit_svi` and scripts) and added `scripts/simulate_tau_sweep.py` plus a `sim_tau_sweep` Snakefile target for recovery experiments.
Added fixed per-interval time scaling (`time_scale`) for the random-walk increments in `src/models/pyro_model.py`, validated in `scripts/pyro_io.py`, threaded through fit/export/diagnostics, and documented in `src/architecture/pyro_model.md`.
Removed unused pipeline stubs from `src/models/pyro_pipeline.py`; only shared helpers (`make_k_centered`, `to_torch`) remain.
Remaining manual/optional items from `src/architecture/pyro_model.md`: manual review of sanity-check outputs (if enabled).
Updated the core Pyro model in `src/models/pyro_model.py` to use fixed-scale priors for alpha/rep/gamma (no hyper-SDs), switched to per-interval `sigma_time` with learned increments (removed `time_scale` scaling), and added a `likelihood_weight` multiplier on the soft-label log-likelihood; updated `fit_svi` and reconstruction utilities to match the new `sigma_time` shape.
Updated exporters and utilities to match the new time-innovation parameterization: added `export_gene_summary_for_mash` (daywise betahat/se), switched `scripts/fit_pyro_export.py` to mashr export, updated diagnostics/loglik reconstruction to the new `sigma_time` shape and likelihood weight, refreshed simulation code/tests to match per-interval `sigma_time`, and removed `time_scale` usage from fitting/export paths.
Added mashr discovery integration: new `envs/mash.yaml` and `scripts/run_mashr.R`, updated `Snakefile` to output `gene_summary_for_mash.csv` then run mashr before `rank_hits`, updated simulation workflow to run mashr, and revised `scripts/rank_hits.py` for mash outputs; `config.yaml` now includes s_alpha/s_rep/s_gamma/s_tau/s_time/s_guide defaults, `likelihood_weight`, and `mash_lfsr_thresh`, with `scripts/pyro_io.py` coercing the new float keys.
Fixed `scripts/run_mashr.R` to compare day indices without name attributes so betahat/se day columns align correctly.
Ran `sim_all` with `sim_cells=500`, `sim_genes=60`, `sim_concentration=200` (no hyperparameter changes); mashr produced 1 hit (Gene57, best_day=3) with `lfsr_min=1e-05` and updated sim outputs in `out_fate_pipeline_sim/`.
Computed daywise ground-truth counts for the same sim settings (seed 0, N=500, L=60, G=90, Kmax=4, concentration=200): day0=29, day1=32, day2=33, day3=37, any-day=47 genes with |beta|>0.2.
Updated `scripts/run_mashr.R` to fall back to identity covariance when `estimate_null_correlation_simple` fails (e.g., insufficient null data), avoiding mashr crashes on small panels.
Ran the real-data pipeline on simulated inputs via Snakemake (fit→mashr→rank with allowed rules). Mashr used identity covariance fallback due to insufficient null data; `out_fate_pipeline_sim/hits_ranked.csv` produced multiple hits (top hits printed in console).
Added `sim_metadata.yaml` output to simulation runs (records sim inputs like cells/genes/guides/concentration/seed, day/rep counts, and k summary), wired it through `scripts/simulate_recovery.py` and the Snakefile, and documented it in `README.md`.
Standardized simulation recovery to daywise outputs: `scripts/simulate_recovery.py` now computes daywise true betas, exports daywise summaries via `export_gene_summary_for_mash`, writes `true_betahat_d*` and `error_d*` columns, and stores `true_gene_betahat_daywise` in AnnData; prior/tau sweep scripts now compare daywise betas as well.
Added `scripts/eval_daywise_hits.py` to evaluate daywise hit calls against daywise ground truth (per-day and overall confusion metrics), and documented it in `README.md`.
Ran `sim_all` after daywise standardization (generated `sim_metadata.yaml` and daywise `sim_recovery.csv`). Daywise evaluation on the fresh outputs (lfsr_thresh=0.05, truth_thresh=0.2) produced zero hits (TP=0, FP=0, FN=72 overall).
Computed a daywise diagnostic report: lfsr quantiles are high across days (median ~0.82–0.97; 1% quantile ~0.27–0.53), so even lfsr<=0.2 yields zero hits; betahat–truth correlations remain high (~0.84–0.90). Per-day true |beta|>0.2 counts: d0=15, d1=18, d2=19, d3=20.
Ran a larger simulation (genes=120, guides=180, cells=30000; 250 cells/gene) into `out_fate_pipeline_sim_big/` with dedicated inputs (`data/sim_adata_big.h5ad`, `data/sim_guide_map_big.csv`), then generated ground-truth lists (`ground_truth_daywise.csv`, `ground_truth_any.csv`). Daywise confusion at lfsr<=0.05, |true|>0.2: day0 TP=1 FP=0 FN=60 TN=59; day1 TP=0 FP=0 FN=60 TN=60; day2 TP=0 FP=0 FN=66 TN=54; day3 TP=0 FP=0 FN=74 TN=46; overall TP=1 FP=0 FN=260 TN=219; any-day TP=1 FP=0 FN=92 TN=27 (saved to `out_fate_pipeline_sim_big/daywise_confusion.csv`).
Mod2 step1: added `reconstruct_delta_samples` in `src/models/pyro_model.py` and extended `scripts/fit_pyro_export.py` to support `--out-gene`/`--out-guide` and export guide-level daywise mash inputs using reconstructed theta+delta with guide/gene mapping.
Mod2 step2: added `scripts/run_mashr_two_mode.R` (conservative/enriched mashr), added `scripts/aggregate_guides_to_genes.py` (guide→gene aggregation with min_lfsr), and updated `scripts/rank_hits.py` to accept aggregated mash inputs with precomputed `lfsr_min`.
Mod2 step3: wired gene+guide mash outputs through `Snakefile` (two-mode gene/guide mash, aggregation, mode comparison) and updated simulation outputs to include guide exports; added `scripts/compare_mash_modes.py`, updated `config.yaml` with mash/aggregation knobs, and added `r-yaml` to `envs/mash.yaml`; README now references the new mashr two-mode workflow.
Mod2 step4: ran a quick syntax check via `python3 -m py_compile` on new Python scripts (aggregate + compare + eval helpers).
Fixed `Snakefile` mash patterns to use string wildcards instead of lambdas after a Snakemake `'function' object is not iterable` error; attempts to update/create the mash conda env for r-yaml timed out due to slow package downloads (no sim run completed yet).
Re-ran `simulate_recovery` to refresh sim outputs with the new gene/guide daywise mash inputs (`out_fate_pipeline_sim/gene_daywise_for_mash.csv`, `out_fate_pipeline_sim/guide_daywise_for_mash.csv`) and updated sim metadata/config.
Ran `snakemake sim_all` in the `sc_dl` env (no `--use-conda`) to regenerate simulated data and execute the updated mash/aggregation workflow; refreshed outputs under `out_fate_pipeline_sim/` (gene/guide daywise mash, mash outputs, aggregated gene table, mode comparison, hits).
Computed hit counts from `out_fate_pipeline_sim/hits_ranked.csv`: `hit_anyday` = 28/30 genes on the latest simulation run.
Checked hit quality against sim ground truth (|true_betahat_d*|>0.2) for the latest run: TP=22, FP=6, FN=0, TN=2; false positives = Gene2, Gene14, Gene6, Gene23, Gene9, Gene17.
Updated `Snakefile` to support running the sim pipeline on an existing AnnData dataset via `sim_use_existing`: skips `simulate_recovery`, adds `sim_export_existing` (fit/export on provided adata/guide map), and defaults `sim_config_path` to `config.yaml` when using existing inputs.
Fixed `Snakefile` ruleorder to only reference `simulate_recovery` when `sim_use_existing` is false (avoids UnknownRuleException).
Moved the conditional `ruleorder` below the `SIM_USE_EXISTING` definition in `Snakefile` to fix a NameError when `sim_use_existing=True`.
Added a mashr fallback in `scripts/run_mashr_two_mode.R`: if mash fails (e.g., singular covariance), retry with canonical covariances and identity V.
Hardened `scripts/run_mashr_two_mode.R` to check if the estimated V is positive definite; fall back to identity V when eigenvalues are non-positive or invalid.
Tightened the V PD check in `scripts/run_mashr_two_mode.R` to treat tiny eigenvalues (<=1e-8 by default, override via `mash_v_eig_floor`) as non-PD and fall back to identity.
Ran `snakemake sim_all` with `sim_use_existing=True` on `sim_adata_100genes.h5ad` (out_dir `out_fate_pipeline_sim_100g`); pipeline completed with identity-V fallback warnings and produced mash outputs, aggregated gene table, mode comparison, and `hits_ranked.csv`.
Generated `out_fate_pipeline_sim_100g/ground_truth_daywise.csv` from `sim_adata_100genes.h5ad` and ran `scripts/eval_daywise_hits.py` on `out_fate_pipeline_sim_100g/mash_gene_enriched.csv`: day0 TP=50 FP=23 FN=0 TN=27; day1 TP=49 FP=38 FN=1 TN=12; day2 TP=45 FP=29 FN=5 TN=21; day3 TP=46 FP=31 FN=4 TN=19; overall TP=190 FP=121 FN=10 TN=79; any-day TP=91 FP=7 FN=0 TN=2.
Ran `snakemake sim_all` with `sim_use_existing=True` on `sim_adata_100genes_af0.1.h5ad` (out_dir `out_fate_pipeline_sim_100g_af0.1`); completed and produced mash outputs, aggregated gene tables, mode comparison, and `hits_ranked.csv`.
Generated `out_fate_pipeline_sim_100g_af0.1/ground_truth_daywise.csv` and evaluated `out_fate_pipeline_sim_100g_af0.1/mash_gene_enriched.csv`: day0 TP=10 FP=37 FN=0 TN=53; day1 TP=10 FP=37 FN=0 TN=53; day2 TP=10 FP=28 FN=0 TN=62; day3 TP=10 FP=20 FN=0 TN=70; overall TP=40 FP=122 FN=0 TN=238; any-day TP=33 FP=35 FN=0 TN=32.
Mod3 step1: updated `config.yaml` with new FP-mitigation defaults (effect_size_eps=0.15, day/anyday mash thresholds and correction, conservative default mode, SE/V regularization knobs, mash_min_strong_for_cov, and meta_fixed aggregation).
Mod3 step2: updated `scripts/run_mashr_two_mode.R` to apply SE inflation/floor, add Matrix-based V regularization (nearPD + eigen floor + shrink), gate data-driven covariances by `mash_min_strong_for_cov`, and output `postsd_d*`.
Mod3 step3: rewrote `scripts/aggregate_guides_to_genes.py` to implement meta_fixed guide→gene aggregation with gene/day posteriors, lfsr, active_days, corrected hit_anyday logic, and new output columns.
Mod3 step4: updated `scripts/rank_hits.py` to rank by min_lfsr_among_active then max_abs_postmean, use day/anyday thresholds when needed, and display active_days/best_day_among_active with daywise columns.
Mod3 step5: updated `Snakefile` to call the new guide→gene aggregator CLI, refreshed mode comparison metrics in `scripts/compare_mash_modes.py`, and added `r-matrix` to `envs/mash.yaml` for V regularization.
Mod3 step6: added permutation calibration support (`scripts/make_permuted_guides.py`, `scripts/perm_summary.py`), new perm config keys in `config.yaml`, and Snakemake rules/targets (`permute_guides` → `perm_*` → `perm_all`).
Mod3 step7: ran `python -m py_compile` on updated/new Python scripts (aggregate, compare, permute, perm_summary, rank_hits) to confirm syntax; mashr/aggregator defaults updated to satisfy acceptance criteria.
Mod3 step8: implementation checklist reviewed; steps 1–7 are now in place, with permutation branch added but not yet executed.
Ran v3 pipeline (`sim_all`) on `sim_adata_100genes_af0.1.h5ad` into `out_fate_pipeline_sim_100g_af0.1_v3` and evaluated daywise confusion using v3 thresholds (lfsr_day=0.05, effect_eps=0.15, bonferroni anyday=0.0125): day0 TP=10 FP=7 FN=0 TN=83; day1 TP=10 FP=11 FN=0 TN=79; day2 TP=10 FP=10 FN=0 TN=80; day3 TP=10 FP=10 FN=0 TN=80; overall TP=40 FP=38 FN=0 TN=322; any-day TP=33 FP=13 FN=0 TN=54 (saved to `out_fate_pipeline_sim_100g_af0.1_v3/daywise_confusion.csv`).
Adjusted permutation branch to accept an explicit `perm_adata_path` (or fall back to `adata_path`) and added `perm_adata_path` to `config.yaml`.
Ran `perm_all` on `sim_adata_100genes_af0.1.h5ad` into `out_fate_pipeline_perm_af0.1` (no hits under conservative defaults) and wrote `perm_summary.json`.
Recomputed `out_fate_pipeline_perm_af0.1/perm_summary.json` to include `hit_active_day_counts`.
Threshold selection: kept v3 defaults (mash_lfsr_thresh_day=0.05, effect_size_eps=0.15, mash_anyday_correction=bonferroni with anyday=0.0125) since permuted calls are zero.
Ran real-data pipeline with v3 thresholds (overrides: adata_path=data/adata.h5ad, guide_map_csv=data/guide_map.csv, out_dir=out_fate_pipeline). Outputs in `out_fate_pipeline/`; conservative hits ranked file is empty (0 hits) and mash V estimation fell back due to insufficient nulls.
Ran `sim_all` with `sim_use_existing=True` on `sim_adata_100genes_af0.1.h5ad` using `data/sim_guide_map.csv` (out_dir `out_fate_pipeline_sim_100g_af0.1_simmap`); produced mash/aggregation outputs and `hits_ranked.csv` with 46 hit_anyday genes.
Evaluated daywise confusion using `out_fate_pipeline_sim_100g_af0.1_simmap/gene_from_guide_mash_conservative.csv` vs `out_fate_pipeline_sim_100g_af0.1/ground_truth_daywise.csv` (lfsr<=0.05, |true|>0.2): day0 TP=10 FP=78 FN=0 TN=12; day1 TP=10 FP=78 FN=0 TN=12; day2 TP=10 FP=75 FN=0 TN=15; day3 TP=10 FP=68 FN=0 TN=22; overall TP=40 FP=299 FN=0 TN=61; any-day TP=33 FP=13 FN=0 TN=54 (saved to `out_fate_pipeline_sim_100g_af0.1_simmap/daywise_confusion.csv`).
Cleared stale Snakemake lock files under `.snakemake/locks/`.
Mod3.2 step1: updated `config.yaml` to set `effect_size_eps=0.20`, add `effect_prob_large_min`, `min_active_days_for_hit_anyday`, and `discovery_source: gene_theta`.
Mod3.2 step2: wired `Snakefile` to use `mash_gene_{default_mode}.csv` for `rank_hits` (main/sim/perm), added `MASH_GENE_DEFAULT` and `PERM_MASH_GENE`, and introduced a `perm_run_mash_gene` rule.
Mod3.2 step3: updated `scripts/rank_hits.py` to compute `plarge_d*`, probabilistic day/any-day calls, and new ranking/columns from mash-gene postmean/postsd/lfsr inputs.
Mod3.2 step4: updated `scripts/eval_daywise_hits.py` to use probabilistic calling against θ truth, write `pred_call_summary.json`, and adjusted `scripts/perm_summary.py` to accept mash-gene inputs.
Mod3.2 step5: ran `python3 -m py_compile` on `scripts/rank_hits.py`, `scripts/eval_daywise_hits.py`, and `scripts/perm_summary.py`.
Fixed `scripts/rank_hits.py` column sorting to parse day indices via regex (avoids splitting on the 'd' in postsd).
Fixed `scripts/perm_summary.py` to compute probabilistic hits from mash-gene inputs and wired `Snakefile` to pass `--config`.
Ran `sim_all` with `sim_use_existing=True` on `sim_adata_100genes_af0.1.h5ad` into `out_fate_pipeline_sim_100g_af0.1_prob` and evaluated probabilistic calls vs θ truth: day0 TP=4 FP=0 FN=6 TN=90; day1 TP=10 FP=5 FN=0 TN=85; day2 TP=10 FP=7 FN=0 TN=83; day3 TP=8 FP=5 FN=2 TN=85; overall TP=32 FP=17 FN=8 TN=343; any-day TP=29 FP=0 FN=4 TN=67; wrote `pred_call_summary.json` (n_hits=29).
Ran `perm_all` into `out_fate_pipeline_perm_af0.1_prob` (n_hits=0 in `perm_summary.json`); note the earlier `perm_all` run triggered `simulate_recovery` and rewrote `data/sim_guide_map.csv` and `data/sim_adata.h5ad`.
Mod3.4 step1: added guide-to-gene mappings (`guide_to_gene`, `n_guides_per_gene`) to `scripts/pyro_io.py`, updated `src/models/pyro_pipeline.py` `to_torch` outputs, and plumbed the new tensors through `scripts/fit_pyro_export.py` and `scripts/run_diagnostics.py`.
Mod3.4 step2: implemented mean-zero guide deviations in `src/models/pyro_model.py` (new `construct_delta_core` centering with guide→gene counts), updated `fit_svi`/`fate_model`/reconstruction and simulation to pass the new mappings, and wired dependent scripts/tests (`scripts/run_diagnostics.py`, `scripts/simulate_recovery.py`, `scripts/render_model.py`, `scripts/test_pyro_model_logic.py`, `tests/test_pyro_model_integration.py`).
Mod3.4 step3: updated tests to reflect new guide→gene inputs and centering (`tests/test_pyro_model_helpers.py`, `tests/test_pyro_io.py`).
Mod3.4 step4: ran `python3 -m py_compile` on updated model, pipeline, IO, diagnostics, simulation, render, and test files.
Mod3.4b step1: updated `scripts/fit_pyro_export.py` to export theta-only gene daywise CSVs and beta guide daywise CSVs from posterior samples, save theta/delta NPZ summaries plus QC CSVs, and log worst delta/offset violations (including offset SD) before raising in simulation mode.
Mod3.4b step2: aligned `export_gene_summary_for_mash` to use posterior SD with `ddof=0` and fixed `_bootstrap_se` plumbing for guide→gene tensors in `scripts/fit_pyro_export.py`.
Mod3.4b step3: ran `python3 -m py_compile` on `scripts/fit_pyro_export.py` and `src/models/pyro_model.py`.
Mod3.4b step4: generalized `construct_delta_core` to accept leading sample dimensions (for Predictive draws), fixing sigma/u shape errors when reconstructing posterior delta samples.
Mod3.4b step5: re-ran `python3 -m py_compile` on `src/models/pyro_model.py` after the delta-core update.
Mod3.4b step6: ran `scripts/fit_pyro_export.py` on `sim_adata_100genes_af0.1.h5ad` (config `config.yaml`, guide map `data/sim_guide_map.csv`) to generate mod3.4b exports under `out_fate_pipeline_sim_100g_af0.1_mod34b/` (theta/delta NPZs, QC CSVs, and gene/guide daywise mash CSVs).
Mod3.4b step7: re-ran the export on `sim_adata_100genes_af0.1.h5ad` using `data/sim_guide_map_100genes_af0.1.csv`, overwriting outputs in `out_fate_pipeline_sim_100g_af0.1_mod34b/`.
Mod3.4b step8: re-ran the mash/aggregation pipeline (`snakemake sim_all` with `sim_use_existing=True`) on `out_fate_pipeline_sim_100g_af0.1_mod34b/`, regenerating mash gene/guide outputs, guide→gene aggregates, mode comparison, and `hits_ranked.csv` with the theta-only gene exports.
Mod3.4b step9: evaluated mod3.4b mash-gene outputs vs ground truth with `scripts/eval_daywise_hits.py` (config thresholds) and wrote `out_fate_pipeline_sim_100g_af0.1_mod34b/daywise_confusion.csv` plus `pred_call_summary.json`.
